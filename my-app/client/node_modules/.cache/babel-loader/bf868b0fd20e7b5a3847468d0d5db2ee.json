{"ast":null,"code":"import { __assign } from 'tslib';\nimport { print } from 'graphql/language/printer';\nimport { InvariantError } from 'ts-invariant';\nvar defaultHttpOptions = {\n  includeQuery: true,\n  includeExtensions: false\n};\nvar defaultHeaders = {\n  accept: '*/*',\n  'content-type': 'application/json'\n};\nvar defaultOptions = {\n  method: 'POST'\n};\nvar fallbackHttpConfig = {\n  http: defaultHttpOptions,\n  headers: defaultHeaders,\n  options: defaultOptions\n};\nvar throwServerError = function (response, result, message) {\n  var error = new Error(message);\n  error.name = 'ServerError';\n  error.response = response;\n  error.statusCode = response.status;\n  error.result = result;\n  throw error;\n};\nvar parseAndCheckHttpResponse = function (operations) {\n  return function (response) {\n    return response.text().then(function (bodyText) {\n      try {\n        return JSON.parse(bodyText);\n      } catch (err) {\n        var parseError = err;\n        parseError.name = 'ServerParseError';\n        parseError.response = response;\n        parseError.statusCode = response.status;\n        parseError.bodyText = bodyText;\n        return Promise.reject(parseError);\n      }\n    }).then(function (result) {\n      if (response.status >= 300) {\n        throwServerError(response, result, \"Response not successful: Received status code \" + response.status);\n      }\n      if (!Array.isArray(result) && !result.hasOwnProperty('data') && !result.hasOwnProperty('errors')) {\n        throwServerError(response, result, \"Server response was missing for query '\" + (Array.isArray(operations) ? operations.map(function (op) {\n          return op.operationName;\n        }) : operations.operationName) + \"'.\");\n      }\n      return result;\n    });\n  };\n};\nvar checkFetcher = function (fetcher) {\n  if (!fetcher && typeof fetch === 'undefined') {\n    var library = 'unfetch';\n    if (typeof window === 'undefined') library = 'node-fetch';\n    throw process.env.NODE_ENV === \"production\" ? new InvariantError(1) : new InvariantError(\"\\nfetch is not found globally and no fetcher passed, to fix pass a fetch for\\nyour environment like https://www.npmjs.com/package/\" + library + \".\\n\\nFor example:\\nimport fetch from '\" + library + \"';\\nimport { createHttpLink } from 'apollo-link-http';\\n\\nconst link = createHttpLink({ uri: '/graphql', fetch: fetch });\");\n  }\n};\nvar createSignalIfSupported = function () {\n  if (typeof AbortController === 'undefined') return {\n    controller: false,\n    signal: false\n  };\n  var controller = new AbortController();\n  var signal = controller.signal;\n  return {\n    controller: controller,\n    signal: signal\n  };\n};\nvar selectHttpOptionsAndBody = function (operation, fallbackConfig) {\n  var configs = [];\n  for (var _i = 2; _i < arguments.length; _i++) {\n    configs[_i - 2] = arguments[_i];\n  }\n  var options = __assign({}, fallbackConfig.options, {\n    headers: fallbackConfig.headers,\n    credentials: fallbackConfig.credentials\n  });\n  var http = fallbackConfig.http;\n  configs.forEach(function (config) {\n    options = __assign({}, options, config.options, {\n      headers: __assign({}, options.headers, config.headers)\n    });\n    if (config.credentials) options.credentials = config.credentials;\n    http = __assign({}, http, config.http);\n  });\n  var operationName = operation.operationName,\n    extensions = operation.extensions,\n    variables = operation.variables,\n    query = operation.query;\n  var body = {\n    operationName: operationName,\n    variables: variables\n  };\n  if (http.includeExtensions) body.extensions = extensions;\n  if (http.includeQuery) body.query = print(query);\n  return {\n    options: options,\n    body: body\n  };\n};\nvar serializeFetchParameter = function (p, label) {\n  var serialized;\n  try {\n    serialized = JSON.stringify(p);\n  } catch (e) {\n    var parseError = process.env.NODE_ENV === \"production\" ? new InvariantError(2) : new InvariantError(\"Network request failed. \" + label + \" is not serializable: \" + e.message);\n    parseError.parseError = e;\n    throw parseError;\n  }\n  return serialized;\n};\nvar selectURI = function (operation, fallbackURI) {\n  var context = operation.getContext();\n  var contextURI = context.uri;\n  if (contextURI) {\n    return contextURI;\n  } else if (typeof fallbackURI === 'function') {\n    return fallbackURI(operation);\n  } else {\n    return fallbackURI || '/graphql';\n  }\n};\nexport { checkFetcher, createSignalIfSupported, fallbackHttpConfig, parseAndCheckHttpResponse, selectHttpOptionsAndBody, selectURI, serializeFetchParameter, throwServerError };","map":{"version":3,"names":["defaultHttpOptions","includeQuery","includeExtensions","defaultHeaders","accept","defaultOptions","method","fallbackHttpConfig","http","headers","options","throwServerError","response","result","message","error","Error","name","statusCode","status","parseAndCheckHttpResponse","operations","text","then","bodyText","JSON","parse","err","parseError","Promise","reject","Array","isArray","hasOwnProperty","map","op","operationName","checkFetcher","fetcher","fetch","library","window","process","env","NODE_ENV","InvariantError","createSignalIfSupported","AbortController","controller","signal","selectHttpOptionsAndBody","operation","fallbackConfig","configs","_i","arguments","length","__assign","credentials","forEach","config","extensions","variables","query","body","print","serializeFetchParameter","p","label","serialized","stringify","e","selectURI","fallbackURI","context","getContext","contextURI","uri"],"sources":["../src/index.ts"],"sourcesContent":["import { Operation } from 'apollo-link';\nimport { print } from 'graphql/language/printer';\nimport { InvariantError } from 'ts-invariant';\n\n/*\n * Http Utilities: shared across links that make http requests\n */\n\n// XXX replace with actual typings when available\ndeclare var AbortController: any;\n\n//Used for any Error for data from the server\n//on a request with a Status >= 300\n//response contains no data or errors\nexport type ServerError = Error & {\n  response: Response;\n  result: Record<string, any>;\n  statusCode: number;\n};\n\n//Thrown when server's resonse is cannot be parsed\nexport type ServerParseError = Error & {\n  response: Response;\n  statusCode: number;\n  bodyText: string;\n};\n\nexport type ClientParseError = InvariantError & {\n  parseError: Error;\n};\n\nexport interface HttpQueryOptions {\n  includeQuery?: boolean;\n  includeExtensions?: boolean;\n}\n\nexport interface HttpConfig {\n  http?: HttpQueryOptions;\n  options?: any;\n  headers?: any; //overrides headers in options\n  credentials?: any;\n}\n\nexport interface UriFunction {\n  (operation: Operation): string;\n}\n\n// The body of a GraphQL-over-HTTP-POST request.\nexport interface Body {\n  query?: string;\n  operationName?: string;\n  variables?: Record<string, any>;\n  extensions?: Record<string, any>;\n}\n\nexport interface HttpOptions {\n  /**\n   * The URI to use when fetching operations.\n   *\n   * Defaults to '/graphql'.\n   */\n  uri?: string | UriFunction;\n\n  /**\n   * Passes the extensions field to your graphql server.\n   *\n   * Defaults to false.\n   */\n  includeExtensions?: boolean;\n\n  /**\n   * A `fetch`-compatible API to use when making requests.\n   */\n  fetch?: WindowOrWorkerGlobalScope['fetch'];\n\n  /**\n   * An object representing values to be sent as headers on the request.\n   */\n  headers?: any;\n\n  /**\n   * The credentials policy you want to use for the fetch call.\n   */\n  credentials?: string;\n\n  /**\n   * Any overrides of the fetch options argument to pass to the fetch call.\n   */\n  fetchOptions?: any;\n}\n\nconst defaultHttpOptions: HttpQueryOptions = {\n  includeQuery: true,\n  includeExtensions: false,\n};\n\nconst defaultHeaders = {\n  // headers are case insensitive (https://stackoverflow.com/a/5259004)\n  accept: '*/*',\n  'content-type': 'application/json',\n};\n\nconst defaultOptions = {\n  method: 'POST',\n};\n\nexport const fallbackHttpConfig = {\n  http: defaultHttpOptions,\n  headers: defaultHeaders,\n  options: defaultOptions,\n};\n\nexport const throwServerError = (response, result, message) => {\n  const error = new Error(message) as ServerError;\n\n  error.name = 'ServerError';\n  error.response = response;\n  error.statusCode = response.status;\n  error.result = result;\n\n  throw error;\n};\n\n//TODO: when conditional types come in ts 2.8, operations should be a generic type that extends Operation | Array<Operation>\nexport const parseAndCheckHttpResponse = operations => (response: Response) => {\n  return (\n    response\n      .text()\n      .then(bodyText => {\n        try {\n          return JSON.parse(bodyText);\n        } catch (err) {\n          const parseError = err as ServerParseError;\n          parseError.name = 'ServerParseError';\n          parseError.response = response;\n          parseError.statusCode = response.status;\n          parseError.bodyText = bodyText;\n          return Promise.reject(parseError);\n        }\n      })\n      //TODO: when conditional types come out then result should be T extends Array ? Array<FetchResult> : FetchResult\n      .then((result: any) => {\n        if (response.status >= 300) {\n          //Network error\n          throwServerError(\n            response,\n            result,\n            `Response not successful: Received status code ${response.status}`,\n          );\n        }\n        //TODO should really error per response in a Batch based on properties\n        //    - could be done in a validation link\n        if (\n          !Array.isArray(result) &&\n          !result.hasOwnProperty('data') &&\n          !result.hasOwnProperty('errors')\n        ) {\n          //Data error\n          throwServerError(\n            response,\n            result,\n            `Server response was missing for query '${\n              Array.isArray(operations)\n                ? operations.map(op => op.operationName)\n                : operations.operationName\n            }'.`,\n          );\n        }\n        return result;\n      })\n  );\n};\n\nexport const checkFetcher = (fetcher: WindowOrWorkerGlobalScope['fetch']) => {\n  if (!fetcher && typeof fetch === 'undefined') {\n    let library: string = 'unfetch';\n    if (typeof window === 'undefined') library = 'node-fetch';\n    throw new InvariantError(`\nfetch is not found globally and no fetcher passed, to fix pass a fetch for\nyour environment like https://www.npmjs.com/package/${library}.\n\nFor example:\nimport fetch from '${library}';\nimport { createHttpLink } from 'apollo-link-http';\n\nconst link = createHttpLink({ uri: '/graphql', fetch: fetch });`);\n  }\n};\n\nexport const createSignalIfSupported = () => {\n  if (typeof AbortController === 'undefined')\n    return { controller: false, signal: false };\n\n  const controller = new AbortController();\n  const signal = controller.signal;\n  return { controller, signal };\n};\n\nexport const selectHttpOptionsAndBody = (\n  operation: Operation,\n  fallbackConfig: HttpConfig,\n  ...configs: Array<HttpConfig>\n) => {\n  let options: HttpConfig & Record<string, any> = {\n    ...fallbackConfig.options,\n    headers: fallbackConfig.headers,\n    credentials: fallbackConfig.credentials,\n  };\n  let http: HttpQueryOptions = fallbackConfig.http;\n\n  /*\n   * use the rest of the configs to populate the options\n   * configs later in the list will overwrite earlier fields\n   */\n  configs.forEach(config => {\n    options = {\n      ...options,\n      ...config.options,\n      headers: {\n        ...options.headers,\n        ...config.headers,\n      },\n    };\n    if (config.credentials) options.credentials = config.credentials;\n\n    http = {\n      ...http,\n      ...config.http,\n    };\n  });\n\n  //The body depends on the http options\n  const { operationName, extensions, variables, query } = operation;\n  const body: Body = { operationName, variables };\n\n  if (http.includeExtensions) (body as any).extensions = extensions;\n\n  // not sending the query (i.e persisted queries)\n  if (http.includeQuery) (body as any).query = print(query);\n\n  return {\n    options,\n    body,\n  };\n};\n\nexport const serializeFetchParameter = (p, label) => {\n  let serialized;\n  try {\n    serialized = JSON.stringify(p);\n  } catch (e) {\n    const parseError = new InvariantError(\n      `Network request failed. ${label} is not serializable: ${e.message}`,\n    ) as ClientParseError;\n    parseError.parseError = e;\n    throw parseError;\n  }\n  return serialized;\n};\n\n//selects \"/graphql\" by default\nexport const selectURI = (\n  operation,\n  fallbackURI?: string | ((operation: Operation) => string),\n) => {\n  const context = operation.getContext();\n  const contextURI = context.uri;\n\n  if (contextURI) {\n    return contextURI;\n  } else if (typeof fallbackURI === 'function') {\n    return fallbackURI(operation);\n  } else {\n    return (fallbackURI as string) || '/graphql';\n  }\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}